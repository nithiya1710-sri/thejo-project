<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="https://media.licdn.com/dms/image/v2/C510BAQE0Bl7hf7aScw/company-logo_200_200/company-logo_200_200/0/1630600313094?e=2147483647&v=beta&t=FZ8EuFLC6bjx0ri55MlDLMQKr-rrqm0hhXqXo1mHjt0" type="image/x-icon" />
  <title>OTDR File Management</title>
  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      width: 100%; 
      font-family: Arial, sans-serif; 
    }
    body { 
      display: flex; 
      justify-content: center; 
      align-items: stretch; 
      background: #f4f4f4; 
    }
    .container { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
      width: 100%; 
      background: #fff; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: #007bff; 
      color: white; 
      padding: 10px; 
    }
    .content { 
      display: flex; 
      flex: 1; 
      overflow: hidden; 
    }
    .folders, .files, .operations { 
      padding: 10px; 
      overflow-y: auto; 
      border-right: 1px solid #ddd; 
    }
    .folders { 
      width: 25%; 
      background: #f9f9f9; 
    }
    .files { 
      width: 50%; 
    }
    .operations { 
      width: 25%; 
      border-right: none; 
      background: #f8f9fa; 
    }
    .folder-item { 
      padding: 8px; 
      cursor: pointer; 
      border-bottom: 1px solid #ddd; 
    }
    .folder-item:hover { 
      background: #e9ecef; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 6px; 
      text-align: left; 
    }
    button { 
      width: 100%; 
      padding: 10px; 
      margin-bottom: 10px; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    button:hover { 
      background: #0056b3; 
    }
    .operation-panel button { 
      background: #6c757d; 
    }
    .operation-panel button:hover { 
      background: #5a6268; 
    }
    .pagination { 
      margin-top: 10px; 
      text-align: center; 
      font-weight: bold; 
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <span>OTDR File Management</span>
    <span>Total Files: <span id="totalFiles">0</span> | <span id="date-time"></span></span>
  </div>
  <div class="content">
    <div class="folders">
      <h3>Folders</h3>
      <div id="folderList"></div>
    </div>
    <div class="files">
      <h3>Files</h3>
      <table>
        <thead>
          <tr id="tableHeader">
            <th>No.</th>
            <th>File Name</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="fileTableBody"></tbody>
      </table>
      <div class="pagination" id="pagination"></div>
    </div>
    <div class="operations">
      <h3>Operations</h3>
      <div id="defaultButtons">
        <input type="file" id="folderInput" webkitdirectory multiple hidden/>
        <button onclick="document.getElementById('folderInput').click()">Upload Folders</button>
        <button onclick="showOperationPanel()">File Operation</button>
        <button onclick="prevPage()">Last Page</button>
        <button onclick="nextPage()">Next Page</button>
        <button onclick="saveSettings()">Save Settings</button>
        <button onclick="window.location.href='home.html'">Exit</button>
        <button onclick="window.location.href='export_report.html'">Export Reports</button>
      </div>
      <div id="operationPanel" class="operation-panel" style="display:none;">
        <button onclick="selectAllFiles()">Select All</button>
        <button onclick="deleteSelectedFiles()">Delete</button>
        <button onclick="renameSelectedFile()">Rename</button>
        <button onclick="downloadSelectedFile()">Open</button>
        <button onclick="hideOperationPanel()">Back</button>
      </div>
    </div>
  </div>
</div>
<script>
let groupedFolders = {};
let checkboxesVisible = false;
let currentFolder = null;
let currentPage = 1;
const pageSize = 10;

// --- LocalStorage Persistence ---
function saveToLocalStorage() {
  localStorage.setItem("groupedFolders", JSON.stringify(groupedFolders));
}

function loadFromLocalStorage() {
  const data = localStorage.getItem("groupedFolders");
  if (data) {
    groupedFolders = JSON.parse(data);
    loadFolders();
    updateTotalFiles();
  }
}

// --- Page Load ---
window.onload = () => {
  loadFromLocalStorage();
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  // Apply saved brightness
  const savedBrightness = localStorage.getItem("brightness") || "100%";
  applyBrightness(savedBrightness);
};

// --- Brightness Control (Helper) ---
function applyBrightness(level) {
  const brightnessLevels = {
    '0%': 0.2, '20%': 0.4, '40%': 0.6,
    '60%': 0.8, '80%': 0.9, '100%': 1
  };
  document.body.style.filter = `brightness(${brightnessLevels[level] || 1})`;
}

// --- Date/Time ---
function updateDateTime() {
  document.getElementById("date-time").textContent = new Date().toLocaleString();
}

// --- File Upload ---
document.getElementById("folderInput").addEventListener("change", function(event) {
  const files = event.target.files;
  if (!files.length) return;

  for (let file of files) {
    // Use webkitRelativePath to find the root folder name
    const folderName = file.webkitRelativePath.split("/")[0];
    
    if (!groupedFolders[folderName]) {
      groupedFolders[folderName] = [];
    }
    
    const reader = new FileReader();
    
    // Read the file as raw binary data
    reader.onload = function(e) {
      // Store the binary data as an Array
      const byteArray = Array.from(new Uint8Array(e.target.result));
      
      groupedFolders[folderName].push({
        name: file.name,
        date: new Date(file.lastModified).toISOString().split("T")[0],
        type: file.type || "application/octet-stream", // Use octet-stream for unknown types like .sor
        binaryData: byteArray // This is the raw file data
      });
      
      // Update UI
      updateTotalFiles();
      loadFolders();
      // If we just uploaded to the currently viewed folder, refresh the file list
      if (currentFolder === folderName) {
        loadFiles();
      }
      saveToLocalStorage();
    };
    
    reader.readAsArrayBuffer(file);
  }
  
  // Clear the input to allow re-uploading the same folder
  event.target.value = "";
});

// --- UI Updates ---
function updateTotalFiles() {
  let total = 0;
  Object.values(groupedFolders).forEach(arr => total += arr.length);
  document.getElementById("totalFiles").textContent = total;
}

function loadFolders() {
  const folderList = document.getElementById("folderList");
  folderList.innerHTML = "";
  Object.keys(groupedFolders).forEach(folder => {
    const div = document.createElement("div");
    div.textContent = `📁 ${folder}`;
    div.className = "folder-item";
    div.onclick = () => {
      currentFolder = folder;
      currentPage = 1;
      loadFiles();
    }
    folderList.appendChild(div);
  });
}

function loadFiles() {
  if (!currentFolder) return;
  
  const files = groupedFolders[currentFolder] || [];
  const tableBody = document.getElementById("fileTableBody");
  tableBody.innerHTML = "";
  const header = document.getElementById("tableHeader");

  // Add/Remove Checkbox column header
  const checkboxHeader = document.getElementById("checkboxHeader");
  if (checkboxesVisible && !checkboxHeader) {
    const th = document.createElement("th");
    th.id = "checkboxHeader";
    th.textContent = "✔";
    header.insertBefore(th, header.firstChild);
  } else if (!checkboxesVisible && checkboxHeader) {
    checkboxHeader.remove();
  }

  // Pagination logic
  const totalPages = Math.ceil(files.length / pageSize) || 1;
  if (currentPage > totalPages) currentPage = totalPages;
  if (currentPage < 1) currentPage = 1;

  const start = (currentPage - 1) * pageSize;
  const paginatedFiles = files.slice(start, start + pageSize);

  // Populate file table
  paginatedFiles.forEach((file, idx) => {
    const row = document.createElement("tr");
    
    // This is the file's index in the *full* array, not the paginated one
    const globalIndex = start + idx; 
    
    if (checkboxesVisible) {
      const cbCell = document.createElement("td");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "file-checkbox";
      // Store the global index, not the paginated one
      cb.dataset.index = globalIndex; 
      cbCell.appendChild(cb);
      row.appendChild(cbCell);
    }
    
    const noCell = document.createElement("td");
    noCell.textContent = globalIndex + 1;
    row.appendChild(noCell);

    const nameCell = document.createElement("td");
    nameCell.textContent = file.name;
    row.appendChild(nameCell);

    const dateCell = document.createElement("td");
    dateCell.textContent = file.date;
    row.appendChild(dateCell);

    tableBody.appendChild(row);
  });

  document.getElementById("pagination").textContent = `Page ${currentPage} / ${totalPages}`;
}

// --- Operation Panel ---
function showOperationPanel() {
  document.getElementById("operationPanel").style.display = "block";
  document.getElementById("defaultButtons").style.display = "none";
  checkboxesVisible = true;
  loadFiles(); // Reload files to show checkboxes
}

function hideOperationPanel() {
  document.getElementById("operationPanel").style.display = "none";
  document.getElementById("defaultButtons").style.display = "block";
  checkboxesVisible = false;
  loadFiles(); // Reload files to hide checkboxes
}

// --- File Operations ---
function selectAllFiles() {
  document.querySelectorAll(".file-checkbox").forEach(cb => cb.checked = true);
}

function deleteSelectedFiles() {
  if (!currentFolder) return;
  
  const selectedIndices = Array.from(document.querySelectorAll(".file-checkbox:checked"))
    .map(cb => parseInt(cb.dataset.index)); // Get the global indices
    
  if (!selectedIndices.length) return alert("No files selected.");
  if (!confirm(`Delete ${selectedIndices.length} selected files?`)) return;

  // **FIX:** Delete from highest index to lowest
  // This prevents the array from re-indexing while we are deleting
  selectedIndices.sort((a, b) => b - a); 
  
  selectedIndices.forEach(index => {
    groupedFolders[currentFolder].splice(index, 1);
  });

  updateTotalFiles();
  loadFiles(); // Reload the current page
  saveToLocalStorage();
}

function renameSelectedFile() {
  if (!currentFolder) return;
  
  const selected = Array.from(document.querySelectorAll(".file-checkbox:checked"));
  if (selected.length !== 1) return alert("Select exactly one file to rename.");
  
  const fileIdx = parseInt(selected[0].dataset.index);
  const oldName = groupedFolders[currentFolder][fileIdx].name;
  const newName = prompt("Enter new name:", oldName);
  
  if (newName && newName !== oldName) {
    groupedFolders[currentFolder][fileIdx].name = newName;
    loadFiles();
    saveToLocalStorage();
  }
}

// --- THIS IS THE DOWNLOAD FUNCTION ---
// It is called by the "Open" button
function downloadSelectedFile() {
  if (!currentFolder) return;

  const selected = Array.from(document.querySelectorAll(".file-checkbox:checked"));
  if (selected.length !== 1) {
    alert("Select exactly one file to download.");
    return;
  }
  
  const fileIdx = parseInt(selected[0].dataset.index);
  const file = groupedFolders[currentFolder][fileIdx];
  
  // Convert the stored simple array back into a binary-compatible Uint8Array
  const byteArray = Uint8Array.from(file.binaryData);
  
  // Create a Blob (Binary Large Object) from the raw binary data
  const blob = new Blob([byteArray], { type: file.type });
  
  // Create a URL that points to the Blob in the browser's memory
  const url = URL.createObjectURL(blob);
  
  // 1. Create a temporary link element
  const a = document.createElement('a');
  a.style.display = 'none';
  a.href = url;
  
  // 2. Set the 'download' attribute to the file's original name (e.g., "test.sor")
  //    This is what forces the browser to download it.
  a.download = file.name; 
  
  // 3. Add the link to the page, click it, and then remove it
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  // 4. Clean up the blob URL to free up memory
  URL.revokeObjectURL(url);
}

function saveSettings() {
  alert("Settings saved.");
}

// --- Pagination ---
function nextPage() {
  if (!currentFolder) return;
  const totalFiles = groupedFolders[currentFolder].length;
  const totalPages = Math.ceil(totalFiles / pageSize) || 1;
  if (currentPage < totalPages) {
    currentPage++;
    loadFiles();
  }
}

function prevPage() {
  if (!currentFolder) return;
  if (currentPage > 1) {
    currentPage--;
    loadFiles();
  }
}
</script>
</body>
</html>
